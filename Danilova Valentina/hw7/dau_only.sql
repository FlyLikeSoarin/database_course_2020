-- DAU, Daily Active Users

USE database_course;

WITH RECURSIVE cte(dt) AS (
	SELECT MIN(CAST(sessions.begin_dttm AS DATE)) AS dt FROM sessions
	UNION ALL
	SELECT dt + INTERVAL 1 DAY
    FROM cte 
	WHERE dt + INTERVAL 1 DAY <= (SELECT MAX(CAST(sessions.begin_dttm AS DATE)) from sessions)
)
SELECT cte.dt, COUNT(DISTINCT sessions.user_id) AS dau
FROM sessions RIGHT JOIN cte ON CAST(sessions.begin_dttm AS DATE) >= cte.dt 
AND CAST(sessions.begin_dttm AS DATE) < cte.dt + INTERVAL 1 WEEK
GROUP BY cte.dt
ORDER BY cte.dt;

-- Результат
-- # dt, dau
-- 2018-08-02, 6
-- 2018-08-03, 7
-- 2018-08-04, 8
-- 2018-08-05, 9
-- 2018-08-06, 10
-- 2018-08-07, 10
-- 2018-08-08, 11
-- 2018-08-09, 11
-- 2018-08-10, 14
-- 2018-08-11, 14
-- 2018-08-12, 16
-- 2018-08-13, 17
-- 2018-08-14, 17
-- 2018-08-15, 17
-- 2018-08-16, 17
-- 2018-08-17, 20
-- 2018-08-18, 20
-- 2018-08-19, 20
-- 2018-08-20, 19
-- 2018-08-21, 19
-- 2018-08-22, 20
-- 2018-08-23, 22
-- 2018-08-24, 22
-- 2018-08-25, 23
-- 2018-08-26, 24
-- 2018-08-27, 25
-- 2018-08-28, 29
-- 2018-08-29, 31
-- 2018-08-30, 31
-- 2018-08-31, 31
-- 2018-09-01, 32
-- 2018-09-02, 32
-- 2018-09-03, 31
-- 2018-09-04, 34
-- 2018-09-05, 34
-- 2018-09-06, 35
-- 2018-09-07, 35
-- 2018-09-08, 35
-- 2018-09-09, 37
-- 2018-09-10, 38
-- 2018-09-11, 39
-- 2018-09-12, 40
-- 2018-09-13, 41
-- 2018-09-14, 45
-- 2018-09-15, 45
-- 2018-09-16, 45
-- 2018-09-17, 46
-- 2018-09-18, 49
-- 2018-09-19, 49
-- 2018-09-20, 50
-- 2018-09-21, 49
-- 2018-09-22, 51
-- 2018-09-23, 52
-- 2018-09-24, 52
-- 2018-09-25, 52
-- 2018-09-26, 52
-- 2018-09-27, 51
-- 2018-09-28, 50
-- 2018-09-29, 49
-- 2018-09-30, 41
